<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatApp | Terminal</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="/static/htmx.min.js"></script>
    <script src="/static/sse.js"></script>
</head>

<body>
    <div class="container">
        <header>
            <h1>JustAChatApp_v1.0.0</h1>
            <div class="user-info">
                <span>user: <strong style="color: var(--prompt-color)">{{.Username}}</strong></span>
                <a href="/login" class="logout-btn">[logout]</a>
            </div>
        </header>

        <main hx-ext="sse" sse-connect="/events">
            <div id="chat-window" class="chat-window" sse-swap="newMessage" hx-swap="beforeend">
                {{range .Messages}}
                <div class="message">
                    <span class="time">[{{.CreatedAt.Format "2006-01-02T15:04:05"}}]</span>
                    <span class="prompt">{{.Username}}:$</span> {{.Content}}
                </div>
                {{end}}
            </div>

            <form hx-post="/send" hx-swap="none" hx-on::after-request="this.reset(); updateCursor();" class="send-form">
                <label for="content">{{.Username}}:$</label>
                <div class="input-wrapper">
                    <input type="text" id="content" name="content" autocomplete="off" required autofocus maxlength="500"
                        oninput="updateCursor()">
                    <div id="cursor" class="terminal-cursor"></div>
                </div>
                <button type="submit">Submit</button>
            </form>
        </main>
    </div>
    <script>
        const chatWindow = document.getElementById('chat-window');
        const contentInput = document.getElementById('content');
        const cursor = document.getElementById('cursor');

        // Auto-scroll to bottom
        const observer = new MutationObserver(() => {
            chatWindow.scrollTop = chatWindow.scrollHeight;
        });
        observer.observe(chatWindow, { childList: true });

        // Position custom cursor
        function updateCursor() {
            const text = contentInput.value;
            // Create a temporary span to measure text width
            const span = document.createElement('span');
            span.style.font = getComputedStyle(contentInput).font;
            span.style.visibility = 'hidden';
            span.style.whiteSpace = 'pre';
            span.textContent = text;
            document.body.appendChild(span);
            const width = span.offsetWidth;
            document.body.removeChild(span);

            cursor.style.left = `${width}px`;
        }

        // Initial position
        updateCursor();
    </script>
</body>

</html>